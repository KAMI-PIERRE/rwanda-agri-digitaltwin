<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agrimodeling - Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Rwanda Agriculture Digital Twin — Dashboard</h1>

    <div style="display:flex; gap:20px; align-items:flex-start;">
      <!-- Left: controls -->
      <div style="width:360px; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <h3>Intervention sliders (0–100)</h3>
        <div id="sliders">
          <!-- sliders are injected here by JS -->
        </div>

        <div style="margin-top:12px;">
          <label for="n_sim">Monte Carlo runs:</label>
          <input id="n_sim" type="number" value="1500" min="200" max="5000" step="100" style="width:120px;">
        </div>

        <button id="runBtn" class="btn" style="margin-top:12px;">Run Projection</button>
        <div style="margin-top:10px;">
          <strong>Probability (≥ $7,000):</strong>
          <div id="probText" style="font-size:20px; color:#1b4f72;">—</div>
          <small id="meanText" style="color:#666;">Mean Ag PPP 2050: —</small>
        </div>
      </div>

      <!-- Right: charts -->
      <div style="flex:1; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <h3>Monte Carlo Distribution (2050)</h3>
        <canvas id="histChart" height="220"></canvas>
        <h3 style="margin-top:18px;">Quantiles</h3>
        <div id="quantiles" style="font-family:monospace; color:#333;">—</div>
      </div>
    </div>

  </div>

<script>
const KPI_ORDER = {{ kpis|tojson }};

// function to create slider HTML
function makeSlider(kpi, defaultValue=60) {
  const wrapper = document.createElement('div');
  wrapper.style.marginBottom = '10px';

  const label = document.createElement('label');
  label.innerText = kpi + " (" + defaultValue + ")";
  label.style.fontSize = '13px';
  label.style.display = 'block';
  label.style.marginBottom = '4px';

  const input = document.createElement('input');
  input.type = 'range';
  input.min = 0;
  input.max = 100;
  input.value = defaultValue;
  input.style.width = '100%';

  input.addEventListener('input', () => {
    label.innerText = kpi + " (" + input.value + ")";
  });

  wrapper.appendChild(label);
  wrapper.appendChild(input);
  return { wrapper, input, label };
}

const slidersDiv = document.getElementById('sliders');
const sliderInputs = {};
// create sliders with sensible defaults
const defaults = {
  "Land Consolidation": 80, "Land Use Productivity": 85, "Irrigation & Water Use Efficiency": 88,
  "Climate Adaptation Index": 75, "Staple Crop Productivity": 82, "Cash Crop Productivity": 80,
  "Livestock Productivity (Breed Improvement & Feeding Systems)": 83, "Inputs Efficiency (fertilizer, seeds)": 80,
  "Soil Health Indicators": 82, "Mechanization": 78, "Digital Agriculture Adoption": 85,
  "R&D + Extension (AI-augmented advisory)": 88, "Digital Twin simulations for plots & cooperatives": 85,
  "Postharvest Loss (%)": 22, "Storage/Processing Value Addition": 80, "Access to Finance": 82,
  "Insurance Penetration": 72, "Domestic Market Integration": 85, "Export Competitiveness": 82,
  "Supply–Demand Stability Score (AI forecast model)": 87
};

KPI_ORDER.forEach(kpi => {
  const d = defaults[kpi] !== undefined ? defaults[kpi] : 50;
  const s = makeSlider(kpi, d);
  slidersDiv.appendChild(s.wrapper);
  sliderInputs[kpi] = s.input;
});

// Chart.js histogram
let histChart = null;
function drawHistogram(values) {
  // convert values to a simple binned histogram for display
  const bins = 40;
  const min = Math.min(...values);
  const max = Math.max(...values);
  const width = (max - min) / bins;
  const counts = new Array(bins).fill(0);
  const labels = new Array(bins).fill(0).map((_,i) => (min + i*width).toFixed(0));
  values.forEach(v => {
    const idx = Math.min(bins-1, Math.floor((v - min) / (width || 1)));
    counts[idx] += 1;
  });

  const ctx = document.getElementById('histChart').getContext('2d');
  if (histChart) histChart.destroy();
  histChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Frequency',
        data: counts,
        backgroundColor: 'rgba(27,79,114,0.8)'
      }]
    },
    options: {
      scales: {
        x: { display: true },
        y: { display: true }
      }
    }
  });
}

document.getElementById('runBtn').addEventListener('click', async () => {
  const interventions = {};
  KPI_ORDER.forEach(k => {
    interventions[k] = Number(sliderInputs[k].value);
  });
  const n_sim = Number(document.getElementById('n_sim').value) || 1500;
  document.getElementById('probText').innerText = 'Running...';
  document.getElementById('meanText').innerText = '';

  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ interventions, n_sim })
    });
    const json = await res.json();
    if (json.status !== 'ok') {
      alert('Error from server');
      return;
    }
    const r = json.result;
    const probPct = (r.prob * 100).toFixed(1);
    document.getElementById('probText').innerText = probPct + '%';
    document.getElementById('meanText').innerText = 'Mean Ag PPP 2050: ' + Math.round(r.mean);

    drawHistogram(r.sample);

    const q = r.quantiles;
    document.getElementById('quantiles').innerText =
      `p5: ${Math.round(q.p5)}  p25: ${Math.round(q.p25)}  p50: ${Math.round(q.p50)}  p75: ${Math.round(q.p75)}  p95: ${Math.round(q.p95)}`;
  } catch (err) {
    console.error(err);
    alert('Request failed: ' + err);
    document.getElementById('probText').innerText = 'Error';
  }
});

// Run initial default projection on page load
document.getElementById('runBtn').click();

</script>
</body>
</html>
